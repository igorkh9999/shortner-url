services:
    postgres:
        image: postgres:16-alpine
        environment:
            POSTGRES_DB: linkanalytics
            POSTGRES_USER: linkuser
            POSTGRES_PASSWORD: linkpass
        ports:
            - '5432:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./backend/db/init.sql:/docker-entrypoint-initdb.d/init.sql
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U linkuser']
            interval: 5s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7-alpine
        ports:
            - '6379:6379'
        volumes:
            - redis_data:/data
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 5s
            timeout: 3s
            retries: 5

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        ports:
            - '8080:8080'
        environment:
            DATABASE_URL: postgres://linkuser:linkpass@postgres:5432/linkanalytics?sslmode=disable
            REDIS_URL: redis:6379
            PORT: 8080
            BASE_URL: http://localhost:8080
            FRONTEND_URL: http://localhost:3000
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        restart: unless-stopped

    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        ports:
            - '3000:3000'
        environment:
            # NEXT_PUBLIC_API_URL is used in browser (client-side), so it must be accessible from user's machine
            # Use localhost for local development, or your domain for production
            NEXT_PUBLIC_API_URL: http://localhost:8080
        depends_on:
            - backend
        restart: unless-stopped

volumes:
    postgres_data:
    redis_data:
